# Creación e instalación de paquete

## Instalar Dependencias

```bash
sudo apt install libmysqlclient-dev libpam0g-dev libjson-c-dev libhttp-parser-dev libyaml-dev libreadline-dev libgtk-3-dev man2html libcurl4-openssl-dev
```

## Descargar y descomprimir

```bash
wget https://download.schedmd.com/slurm/slurm-23.11.10.tar.bz2
tar xvjf slurm-23.11.10.tar.bz2
```

Configurar SLURM:

```bash
cd slurm-23.11.10
./configure \
    --build=aarch64-linux-gnu \
    --prefix=/usr \
    --with-pmix=/opt/pmix/install/4.2.8 \
    --enable-pam \
    --disable-debug \
    --sysconfdir=/etc/slurm \
    --with-systemdsystemunitdir=/lib/systemd/system/ \
    --libdir=/usr/lib/aarch64-linux-gnu
```

Crear carpeta de instalación

```bash
mkdir ~/slurm-package
```

Compilar e instalar:

```bash
make -j$(nproc)
make install DESTDIR=~/slurm-package
```

La estructura de la carpeta debe replicar el árbol de directorios de Linux con los respectivos archivos instalados.

```bash
/home/jetson/slurm-package/
├── usr/
│   ├── bin/
│   ├── lib/
│   └── sbin/
└── lib/
    └── systemd/
        └── system/
            ├── slurmd.service
            └── slurmctld.service
```

Antes de empaquetar la instalación, comprobar que los archivos de los servicios de SLURM apunten a la dirección correcta del sistema. Verificar en:
```bash
nano lib/systemd/system/slurmd.service
nano lib/systemd/system/slurmctld.service
```
La línea `ExecStart` debe apuntar a `/usr/sbin/slurmd` o `/usr/sbin/slurmctld` de acuerdo al archivo.

Si todo está en orden, continuar.

## Crear paquete

**FPM** es una herramienta muy flexible y fácil de usar para crear paquetes **.deb** a partir de archivos ya instalados.

1. **Instalar FPM**:
    
    ```bash
    sudo apt-get install ruby-dev build-essential && sudo gem i fpm -f
    ```
    
2. **Crear el paquete `.deb`** con FPM:
El siguiente comando empaqueta la instalación de SLURM ya realizada:
    
    ```bash
    cd ~
    fpm -s dir -t deb -n slurm --version 23.11.10 --prefix=/ -C ~/slurm-package .
    ```
    
    El paquete creado `slurm_23.11.10_arm64.deb` se pasa al NAS para futuras instalaciones:
    
    ```bash
    cp slurm_23.11.10_arm64.deb /export/jmjarami/
    ```
    

---

## Instalación del paquete

Recordar instalar primero las dependencias para los demás nodos que no van a compilar el programa.

```bash
sudo dpkg -i slurm_23.11.10_arm64.deb
```

Verificando la instalación de los binarios y servicios:

```bash
which srun
which slurmd
which slurmctld
```

# Configuración

### Archivo slurm.conf

Crear un archivo de configuración `slurm.config` . Si ya se ha creado en el nodo principal, simplemente copiarlo a la ruta. El archivo de configuración debe ser el mismo en todos los nodos del cluster para mantener la consistencia. 

```bash
sudo mkdir /etc/slurm/
sudo nano /etc/slurm/slurm.config
```

**`slurm.conf`**  puede ser generado utilizando las herramientas disponibles en línea:

Versión simple:
[Easy Slurm System Configuration](https://slurm.schedmd.com/configurator.easy.html) 

Versión completa:
[Slurm System Configuration Tool](https://slurm.schedmd.com/configurator.html)


El archivo configurado para el cluster final es el siguiente:

```bash
# slurm.conf file generated by configurator easy.html.
# Put this file on all nodes of your cluster.
# See the slurm.conf man page for more information.
#
ClusterName=cluster-test
SlurmctldHost=broly
#
#MailProg=/bin/mail
#MpiDefault=
#MpiParams=ports=#-#
ProctrackType=proctrack/cgroup
ReturnToService=1
SlurmctldPidFile=/var/run/slurmctld.pid
#SlurmctldPort=6817
SlurmdPidFile=/var/run/slurmd.pid
#SlurmdPort=6818
SlurmdSpoolDir=/var/spool/slurmd
SlurmUser=slurm
#SlurmdUser=root
StateSaveLocation=/var/spool/slurmctld
#SwitchType=
TaskPlugin=task/affinity,task/cgroup
#
#
# TIMERS
#KillWait=30
#MinJobAge=300
#SlurmctldTimeout=120
#SlurmdTimeout=300
#
#
# SCHEDULING
SchedulerType=sched/backfill
SelectType=select/cons_tres
#
#
# LOGGING AND ACCOUNTING
#AccountingStorageType=
#JobAcctGatherFrequency=30
#JobAcctGatherType=
#SlurmctldDebug=info
SlurmctldLogFile=/var/log/slurmctld.log
#SlurmdDebug=info
SlurmdLogFile=/var/log/slurmd.log
#
#
# COMPUTE NODES
NodeName=node[1-10] CPUs=4 State=UNKNOWN
PartitionName=nano Nodes=ALL Default=YES MaxTime=INFINITE State=UP
```

## Usuario y permisos

Se configura un usuario dedicado para el servicio de SLURM. Todos los nodos deben usar el mismo UID y GID.

```bash
export SLURMUSER=64030
sudo groupadd -g $SLURMUSER slurm
sudo useradd -m -c "SLURM workload manager" -d /var/lib/slurm -u $SLURMUSER -g slurm -s /bin/bash slurm
```

Asignar permisos

```bash
sudo mkdir -p /var/spool/slurmd /run/slurm
sudo touch /var/log/slurmd.log
sudo chown -R slurm:slurm /var/spool/slurmd /run/slurm /var/log/slurmd.log /etc/slurm/slurm.conf
sudo chmod 755 /var/spool/slurmd /run/slurm
sudo chmod 644 /var/log/slurmd.log /etc/slurm/slurm.conf

```

# Iniciando servicios

**Habilitar e iniciar los servicios de SLURM**:
Si todo está correctamente configurado, se puede habilitar e iniciar los servicios de SLURM:

```bash
sudo systemctl daemon-reload
```

Servicios para el nodo principal (HEAD)

```bash
sudo systemctl enable slurmctld
sudo systemctl start slurmctld

# otros comandos utiles en HEAD
sudo systemctl status slurmctld
sudo systemctl restart slurmctld
```

Servicios para los nodos de computo (NODE)

```bash
sudo systemctl enable slurmd
sudo systemctl start slurmd

# otros comandos utiles en NODE
sudo systemctl status slurmd
sudo systemctl restart slurmd
```
